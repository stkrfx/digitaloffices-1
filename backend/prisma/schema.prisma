generator client {
  provider     = "prisma-client"
  output       = "../src/generated/prisma"
  moduleFormat = "esm"
}

datasource db {
  provider = "postgresql"
}

// --------------------------------------
// ENUMS
// --------------------------------------

enum AdminRole {
  SUPER_ADMIN
  MODERATOR
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

enum ThemePreference {
  LIGHT
  DARK
  SYSTEM
}

// --------------------------------------
// IDENTITY MODELS (SILOED)
// --------------------------------------

model User {
  id                     String    @id @default(uuid())
  email                  String    @unique
  passwordHash           String?
  googleId               String?   @unique
  isBlocked              Boolean   @default(false)
  deletedAt              DateTime? // Soft Delete
  emailVerifiedAt        DateTime?
  emailVerificationToken String?
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  // User Specific Fields
  name                     String
  avatarUrl                String?
  promotionalEmailsEnabled Boolean @default(false)

  // Relations
  refreshSessions RefreshSession[]
  bookings        Booking[]
  reviews         Review[]
  preferences     UserPreference?

  @@index([email])
}

model Expert {
  id                     String    @id @default(uuid())
  email                  String    @unique
  passwordHash           String?
  googleId               String?   @unique
  isBlocked              Boolean   @default(false)
  deletedAt              DateTime? // Soft Delete
  emailVerifiedAt        DateTime?
  emailVerificationToken String?
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  // Expert Specific Fields
  name        String
  username    String   @unique
  avatarUrl   String?
  headline    String?
  bio         String?
  hourlyRate  Decimal? @db.Decimal(10, 2)
  specialties String[]
  isVerified  Boolean  @default(false)

  // Relations
  refreshSessions RefreshSession[]
  services        Service[]
  availability    Availability[]
  bookings        Booking[]
  preferences     UserPreference?

  @@index([email])
  @@index([username])
}

model Organization {
  id                     String    @id @default(uuid())
  email                  String    @unique
  passwordHash           String?
  googleId               String?   @unique
  isBlocked              Boolean   @default(false)
  deletedAt              DateTime? // Soft Delete
  emailVerifiedAt        DateTime?
  emailVerificationToken String?
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  // Organization Specific Fields
  companyName String
  logoUrl     String?
  websiteUrl  String?
  regNumber   String?

  // Relations
  refreshSessions RefreshSession[]
  services        Service[]
  bookings        Booking[]
  preferences     UserPreference?

  @@index([email])
}

model Admin {
  id                     String    @id @default(uuid())
  email                  String    @unique
  passwordHash           String?
  googleId               String?   @unique
  isBlocked              Boolean   @default(false)
  deletedAt              DateTime?
  emailVerifiedAt        DateTime?
  emailVerificationToken String?
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  name String
  role AdminRole

  refreshSessions RefreshSession[]

  @@index([email])
}

// --------------------------------------
// DOMAIN MODELS
// --------------------------------------

model Service {
  id          String   @id @default(uuid())
  title       String
  description String?
  price       Decimal  @db.Decimal(10, 2)
  durationMin Int // Duration in minutes
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Ownership (Service can belong to either an Expert or an Org)
  expertId       String?
  organizationId String?
  Expert         Expert?       @relation(fields: [expertId], references: [id], onDelete: Cascade)
  Organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  bookings Booking[]

  @@index([expertId])
  @@index([organizationId])
}

model Availability {
  id        String @id @default(uuid())
  dayOfWeek Int // 0 (Sunday) to 6 (Saturday)
  startTime String // "09:00"
  endTime   String // "17:00"

  expertId String
  Expert   Expert @relation(fields: [expertId], references: [id], onDelete: Cascade)

  @@index([expertId])
}

model Booking {
  id         String        @id @default(uuid())
  startTime  DateTime
  endTime    DateTime
  status     BookingStatus @default(PENDING)
  totalPrice Decimal       @db.Decimal(10, 2)
  notes      String?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  // Relations
  userId    String
  User      User    @relation(fields: [userId], references: [id])
  serviceId String
  Service   Service @relation(fields: [serviceId], references: [id])

  // Cache the provider IDs for easier querying
  expertId       String?
  Expert         Expert?       @relation(fields: [expertId], references: [id])
  organizationId String?
  Organization   Organization? @relation(fields: [organizationId], references: [id])

  review Review?

  @@index([userId])
  @@index([serviceId])
  @@index([expertId])
  @@index([organizationId])
}

model Review {
  id        String   @id @default(uuid())
  rating    Int // 1 to 5
  comment   String?
  createdAt DateTime @default(now())

  bookingId String  @unique
  Booking   Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  userId    String
  User      User    @relation(fields: [userId], references: [id])

  @@index([userId])
}

model UserPreference {
  id       String          @id @default(uuid())
  theme    ThemePreference @default(SYSTEM)
  language String          @default("en")
  timezone String          @default("UTC")

  // Polymorphic Owner
  userId         String? @unique
  expertId       String? @unique
  organizationId String? @unique

  User         User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  Expert       Expert?       @relation(fields: [expertId], references: [id], onDelete: Cascade)
  Organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

// --------------------------------------
// SESSION MANAGEMENT
// --------------------------------------

model RefreshSession {
  id        String   @id @default(uuid())
  tokenHash String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  userId         String?
  expertId       String?
  organizationId String?
  adminId        String?

  User         User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  Expert       Expert?       @relation(fields: [expertId], references: [id], onDelete: Cascade)
  Organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  Admin        Admin?        @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expertId])
  @@index([organizationId])
  @@index([adminId])
}
